================================================================================
MILESTONE PARSER USAGE GUIDE
================================================================================

This guide explains how to use the milestone parsers and update scripts to
maintain the milestone data in the Toddl application.

⭐ CANONICAL SOURCE APPROACH (Nov 2025):
   dev-milestones-comprehensive.md is the SINGLE SOURCE OF TRUTH for milestone
   titles. All parsers use shared normalization for consistency. Database
   migration preserves child progress while adopting canonical titles.

================================================================================
AVAILABLE FILES (11 TOTAL)
================================================================================

All parser-related files are organized in server/parsers/ folder:

CANONICAL PARSERS ⭐:
  1. server/parsers/parse-comprehensive-milestones.ts - Canonical title parser
  2. server/parsers/title-normalizer.ts - Shared normalization (used by all)

MIGRATION & VALIDATION ⭐:
  3. server/parsers/migrate-to-canonical-titles.ts - Database migration tool
  4. server/parsers/validate-title-consistency.ts - Cross-file validation

LEGACY PARSERS (for reference/backward compatibility):
  5. server/parsers/parse-milestones.ts
  6. server/parsers/milestone-description-parser.ts
  7. server/parsers/parse-milestone-sources.ts

UPDATE SCRIPTS (executable - modify existing milestones):
  8. server/parsers/update-milestones-from-file.ts
  9. server/parsers/update-milestone-descriptions-from-file.ts
  10. server/parsers/update-milestone-sources-from-file.ts

SEED SCRIPTS (executable - create new milestones):
  11. server/parsers/seed-all-milestones-from-categorised-source.ts

All parsers use shared title normalization for consistency.

================================================================================
PARSER DETAILS
================================================================================

1. server/parsers/parse-milestones.ts
   - Parses core milestone data (title, category, age ranges)
   - Input: Markdown file with milestone tables
   - Output: Array of milestone objects
   - Function: extractMilestones(filePath)
   - Used by: update-milestones-from-file.ts

2. server/parsers/milestone-description-parser.ts
   - Parses detailed milestone descriptions
   - Input: Markdown file with structured descriptions
   - Output: Array of description objects with About/What to look for/Why it matters
   - Function: parseMilestoneDescriptions(fileContent)
   - Used by: update-milestone-descriptions-from-file.ts

3. server/parsers/parse-milestone-sources.ts
   - Parses milestone source attribution from all 7 international health organizations
   - Sources: CDC/AAP, HSE, WHO, NHS, Australian Dept of Health, Health Canada/CPS, South Africa DoH
   - Input: Markdown file with milestones organized by authoritative source
   - Output: Array of milestone-source mapping objects with full milestone data
   - Function: parseMilestoneSourcesFromFile(filePath)
   - Used by: update-milestone-sources-from-file.ts, seed-all-milestones-from-categorised-source.ts
   - Special Features:
     * Handles comma-separated milestones within age markers (e.g., "**30M:** A, B, C")
     * Respects parentheses when splitting on commas (preserves "Twists things (doorknobs, lids)")
     * Prevents title truncation by tracking parenthesis depth during parsing

================================================================================
UPDATE SCRIPTS
================================================================================

1. UPDATE CORE MILESTONE DATA (age ranges, categories, etc.)
   
   File: server/parsers/update-milestones-from-file.ts
   
   Command:
   $ tsx server/parsers/update-milestones-from-file.ts <path-to-milestone-file>

   Example:
   $ tsx server/parsers/update-milestones-from-file.ts ./attached_assets/dev-milestones-comprehensive.md

   What it does:
   - Uses parse-milestones.ts to parse milestone data from the file
   - Matches milestones by title with database
   - Updates age ranges, categories, and subcategories
   - Shows detailed summary of changes before updating

   When to use:
   - New milestone data file with corrected age ranges
   - Category/subcategory reorganization
   - Any structural milestone data updates


2. UPDATE MILESTONE DESCRIPTIONS

   File: server/parsers/update-milestone-descriptions-from-file.ts

   Command:
   $ tsx server/parsers/update-milestone-descriptions-from-file.ts <path-to-description-file>

   Example:
   $ tsx server/parsers/update-milestone-descriptions-from-file.ts ./attached_assets/milestones-descriptions.md

   What it does:
   - Uses milestone-description-parser.ts to parse structured descriptions
   - Matches descriptions to milestones by normalized title
   - Updates description field in database
   - Reports coverage statistics

   When to use:
   - New description content available
   - Updating evidence-based citations
   - Improving parent guidance text


3. UPDATE MILESTONE SOURCES

   File: server/parsers/update-milestone-sources-from-file.ts

   Command:
   $ tsx server/parsers/update-milestone-sources-from-file.ts <path-to-source-file>

   Example:
   $ tsx server/parsers/update-milestone-sources-from-file.ts ./attached_assets/milestones-categorised-by-source.md

   What it does:
   - Uses parse-milestone-sources.ts to parse source attribution data
   - Matches milestones by title, category, and age range
   - Updates sources field (array) in database
   - Supports multiple sources per milestone (e.g., CDC/AAP + HSE + WHO)
   - Reports coverage statistics and unmatched entries

   When to use:
   - New source attribution data available
   - Adding or updating which organizations publish each milestone
   - Enabling user preference filtering by source
   - When you want to update sources WITHOUT creating new milestones

   Available Sources:
   - CDC/AAP (USA - Centers for Disease Control / American Academy of Pediatrics)
   - HSE (Ireland - Health Service Executive)
   - WHO (International - World Health Organization)
   - NHS (UK - National Health Service)
   - Health Canada/CPS (Canada - Health Canada / Canadian Paediatric Society)
   - Australian Dept of Health (Australia - Pregnancy Birth and Baby, Queensland Health)
   - South Africa DoH (South Africa - Department of Health)


4. SEED ALL MILESTONES FROM CATEGORISED SOURCE FILE (COMPREHENSIVE)

   File: server/parsers/seed-all-milestones-from-categorised-source.ts

   Command:
   $ tsx server/parsers/seed-all-milestones-from-categorised-source.ts <path-to-source-file>

   Example:
   $ tsx server/parsers/seed-all-milestones-from-categorised-source.ts ./attached_assets/milestones-categorised-by-source.md

   What it does:
   - Uses parse-milestone-sources.ts to extract ALL milestones from the file
   - Creates NEW milestone records for milestones that don't exist in database
   - Updates sources field for ALL milestones (existing + newly created)
   - Provides detailed statistics on created vs updated milestones
   - Most comprehensive seeding script - handles both creation and updates

   When to use:
   - Initial database population from categorised source file
   - When you have a comprehensive source file with ALL milestones across all organizations
   - When you want to ensure database has complete milestone coverage from all sources
   - When you need to both CREATE new milestones AND assign sources in one step

   Advantages over update-milestone-sources-from-file.ts:
   - Creates missing milestones instead of just updating existing ones
   - Ideal for bootstrapping database with complete international milestone sets
   - Single script to populate 473 milestones from 7 health organizations

   Statistics Reported:
   - Total unique milestones in file
   - Milestones created (new records)
   - Milestones updated (existing records with new sources)
   - Milestones unchanged (already had correct sources)

================================================================================
FILE FORMAT REQUIREMENTS
================================================================================

MILESTONE DATA FILE FORMAT:
- Markdown tables with columns: Milestone, Category, Age Range
- Age range format: "X-Y months" or "X months"
- Categories: Developmental, Growth, Vision, Hearing, Teeth
- See: attached_assets/dev-milestones-comprehensive_*.md

DESCRIPTION FILE FORMAT:
- Markdown headings (##) for each milestone title
- Three required sections:
  **About** - Comprehensive explanation
  **What to look for** - Bullet points of observable behaviors
  **Why it matters** - Bullet points of developmental significance
- See: attached_assets/milestones-descriptions_*.md

SOURCE FILE FORMAT:
- Markdown with source organization headings (##)
- Age range subsections (###)
- Tables with columns: Category, Subcategory, Milestones
- Milestones can have age markers like "**2M:**" for specific months
- Bullet points (•) separate individual milestones
- Multiple sources can contain the same milestone
- See: attached_assets/milestones-categorised-by-source_*.md

================================================================================
MATCHING LOGIC
================================================================================

Both scripts use title matching with normalization:
- Convert to lowercase
- Trim whitespace
- Strip age prefixes (e.g., "0-1m: " removed)

This allows descriptions to match milestones even if formatting differs.

Known Limitations:
- Titles truncated at 60 chars in database may not match
- Combined titles (e.g., "Does X, Does Y") may not match granular descriptions
- Generic numeric titles (e.g., "Boys 22 lb; Girls 20 lb") may not match

================================================================================
WORKFLOW
================================================================================

INITIAL DATABASE POPULATION (Complete Bootstrap):

1. Obtain comprehensive source-categorised milestone file (markdown format)
2. Run the comprehensive seed script:
   $ tsx server/parsers/seed-all-milestones-from-categorised-source.ts <source-file>
3. Obtain descriptions file (markdown format)
4. Update descriptions:
   $ tsx server/parsers/update-milestone-descriptions-from-file.ts <description-file>
5. Verify coverage (should have ~473 milestones across 7 sources)

Example:
$ tsx server/parsers/seed-all-milestones-from-categorised-source.ts ./attached_assets/milestones-categorised-by-source.md
$ tsx server/parsers/update-milestone-descriptions-from-file.ts ./attached_assets/milestones-descriptions.md

This workflow creates all milestones with source attribution, then adds descriptions.


INCREMENTAL UPDATE WORKFLOW (Modify Existing Milestones):

1. Obtain new milestone data file (markdown format)
2. Obtain new descriptions file (markdown format)
3. Obtain new source attribution file (markdown format) - optional
4. Update core milestone data:
   $ tsx server/parsers/update-milestones-from-file.ts <milestone-file>
5. Update descriptions:
   $ tsx server/parsers/update-milestone-descriptions-from-file.ts <description-file>
6. Update source attributions (optional):
   $ tsx server/parsers/update-milestone-sources-from-file.ts <source-file>
7. Verify coverage and check for unmatched milestones
8. Document updates in server/MILESTONE_UPDATE_REPORT.md

This workflow updates existing milestone records without creating new ones.

================================================================================
TROUBLESHOOTING
================================================================================

Q: Script shows "Unmatched in database" - what does this mean?
A: The description file has entries that don't match any database milestone.
   This is normal when the description file has more granular detail than
   the core milestone set.

Q: Script shows "Unmatched in file" - is this a problem?
A: These are milestones in the database without matching descriptions.
   Common causes: title truncation, combined titles, generic formats.
   Review the list and consider manual description creation if needed.

Q: How do I add descriptions for the unmatched milestones?
A: Add entries to the description file using the exact title from the database,
   then re-run the update script.

Q: Parser shows warnings - should I be concerned?
A: Check the warning message. File header warnings are normal and expected.
   Other warnings may indicate formatting issues in the source file.

Q: I see truncated milestone titles like "lids)" or "lower)" - what happened?
A: This was a parsing bug fixed in Nov 2025. The parser now correctly handles
   commas inside parentheses. If you see truncated titles:
   1. Delete the corrupted milestones from the database
   2. Re-run seed-all-milestones-from-categorised-source.ts
   3. The parser will create correctly formatted titles
   Example: "Twists things (doorknobs, lids)" instead of just "lids)"

================================================================================
MAINTENANCE
================================================================================

The parsers are designed to be zero-maintenance and handle variations in
input file formatting. If you need to:

- Add new milestone categories: Update schema.ts first
- Change title normalization: Modify milestone-description-parser.ts
- Add new description sections: Update parser and schema accordingly

Always test with sample data before processing production updates.

================================================================================
CHANGELOG
================================================================================

November 2025 - Parentheses Handling Fix:
- Fixed parse-milestone-sources.ts to respect parentheses when splitting on commas
- Added splitByCommasRespectingParentheses() helper function
- Prevents title truncation for milestones like "Twists things (doorknobs, lids)"
- Re-seeded database to fix 41 corrupted milestone titles
- Updated documentation with troubleshooting guidance

November 2025 - Multi-Source System:
- Added comprehensive seed script: seed-all-milestones-from-categorised-source.ts
- Expanded to 7 international health organizations (was 4)
- Total milestone database: 470 milestones across all sources
- Updated all source names to match official organization names

================================================================================
