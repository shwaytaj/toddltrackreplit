================================================================================
MILESTONE PARSER USAGE GUIDE
================================================================================

This guide explains how to use the milestone parsers and update scripts to
maintain the milestone data in the Toddl application.

⭐ CANONICAL SOURCE APPROACH (Nov 2025):
   dev-milestones-comprehensive.md is the SINGLE SOURCE OF TRUTH for milestone
   titles. All parsers use shared normalization for consistency. Database
   migration preserves child progress while adopting canonical titles.

================================================================================
AVAILABLE FILES (7 TOTAL)
================================================================================

All parser-related files are organized in server/parsers/ folder:

CANONICAL PARSERS ⭐:
  1. server/parsers/parse-comprehensive-milestones.ts - Canonical title parser
  2. server/parsers/title-normalizer.ts - Shared normalization (used by all)

VALIDATION TOOLS:
  3. server/parsers/validate-title-consistency.ts - Cross-file title validation

REUSABLE PARSERS:
  4. server/parsers/milestone-description-parser.ts - Parses milestone descriptions
  5. server/parsers/parse-milestone-source-mappings-v2.ts - Improved source parser (Nov 2025)

UPDATE SCRIPTS (executable - apply data to existing milestones):
  6. server/parsers/update-milestone-descriptions-from-file.ts - Update descriptions
  7. server/parsers/update-milestone-sources.ts - Update sources (uses v2 parser)

DOCUMENTATION:
  8. PARSER_USAGE_GUIDE.txt - This file

All parsers use shared title normalization for consistency.

================================================================================
PARSER DETAILS
================================================================================

1. server/parsers/parse-milestones.ts
   - Parses core milestone data (title, category, age ranges)
   - Input: Markdown file with milestone tables
   - Output: Array of milestone objects
   - Function: extractMilestones(filePath)
   - Used by: update-milestones-from-file.ts

2. server/parsers/milestone-description-parser.ts
   - Parses detailed milestone descriptions
   - Input: Markdown file with structured descriptions
   - Output: Array of description objects with About/What to look for/Why it matters
   - Function: parseMilestoneDescriptions(fileContent)
   - Used by: update-milestone-descriptions-from-file.ts

3. server/parsers/parse-milestone-source-mappings-v2.ts
   - Improved parser for milestone source attribution (Nov 2025)
   - Parses source mappings from all 7 international health organizations
   - Sources: CDC/AAP, HSE, WHO, NHS, Australian Dept of Health, Health Canada/CPS, South Africa DoH
   - Input: Markdown file (milestones-categorised-by-source.md)
   - Output: 935 unique milestone-source mappings (120% improvement over v1)
   - Function: parseMilestoneSourceMappingsV2(filePath)
   - Used by: update-milestone-sources.ts
   - Key Improvements:
     * Smart age-prefix detection (e.g., "**2M:**" markers)
     * Improved metadata filtering (excludes table headers, category labels)
     * Better handling of quoted text with commas
     * Prevents title fragmentation from naive comma-splitting
   - Coverage: 96.3% Developmental, 99% Growth, 100% Teeth, 97.7% Hearing, 95.7% Vision

================================================================================
UPDATE SCRIPTS
================================================================================

1. UPDATE CORE MILESTONE DATA (age ranges, categories, etc.)
   
   File: server/parsers/update-milestones-from-file.ts
   
   Command:
   $ tsx server/parsers/update-milestones-from-file.ts <path-to-milestone-file>

   Example:
   $ tsx server/parsers/update-milestones-from-file.ts ./attached_assets/dev-milestones-comprehensive.md

   What it does:
   - Uses parse-milestones.ts to parse milestone data from the file
   - Matches milestones by title with database
   - Updates age ranges, categories, and subcategories
   - Shows detailed summary of changes before updating

   When to use:
   - New milestone data file with corrected age ranges
   - Category/subcategory reorganization
   - Any structural milestone data updates


2. UPDATE MILESTONE DESCRIPTIONS

   File: server/parsers/update-milestone-descriptions-from-file.ts

   Command:
   $ tsx server/parsers/update-milestone-descriptions-from-file.ts <path-to-description-file>

   Example:
   $ tsx server/parsers/update-milestone-descriptions-from-file.ts ./attached_assets/milestones-descriptions.md

   What it does:
   - Uses milestone-description-parser.ts to parse structured descriptions
   - Matches descriptions to milestones by normalized title
   - Updates description field in database
   - Reports coverage statistics

   When to use:
   - New description content available
   - Updating evidence-based citations
   - Improving parent guidance text


3. UPDATE MILESTONE SOURCES (IMPROVED - Nov 2025)

   File: server/parsers/update-milestone-sources.ts

   Command:
   $ tsx server/parsers/update-milestone-sources.ts <path-to-source-file>

   Example:
   $ tsx server/parsers/update-milestone-sources.ts ./attached_assets/milestones-categorised-by-source_1762122777524.md

   What it does:
   - Uses parse-milestone-source-mappings-v2.ts (improved parser)
   - Extracts 935 unique milestone-source mappings from markdown
   - Matches milestones by normalized title
   - Updates sources field (array) in database
   - Supports multiple sources per milestone (e.g., CDC/AAP + HSE + WHO)
   - Reports detailed coverage statistics by category

   When to use:
   - Updating source attribution data with improved parser
   - Adding which organizations publish each milestone
   - Enabling user preference filtering by source
   - Updates existing milestones without creating new ones

   Key Improvements (v2 parser):
   - 120% more mappings extracted (935 vs 424)
   - Smart age-prefix detection prevents fragmentation
   - Better metadata filtering (excludes headers, labels)
   - 96.3% Developmental coverage, >95% all categories

   Available Sources:
   - CDC/AAP (USA - Centers for Disease Control / American Academy of Pediatrics)
   - HSE (Ireland - Health Service Executive)
   - WHO (International - World Health Organization)
   - NHS (UK - National Health Service)
   - Health Canada/CPS (Canada - Health Canada / Canadian Paediatric Society)
   - Australian Dept of Health (Australia - Pregnancy Birth and Baby, Queensland Health)
   - South Africa DoH (South Africa - Department of Health)



================================================================================
FILE FORMAT REQUIREMENTS
================================================================================

MILESTONE DATA FILE FORMAT:
- Markdown tables with columns: Milestone, Category, Age Range
- Age range format: "X-Y months" or "X months"
- Categories: Developmental, Growth, Vision, Hearing, Teeth
- See: attached_assets/dev-milestones-comprehensive_*.md

DESCRIPTION FILE FORMAT:
- Markdown headings (##) for each milestone title
- Three required sections:
  **About** - Comprehensive explanation
  **What to look for** - Bullet points of observable behaviors
  **Why it matters** - Bullet points of developmental significance
- See: attached_assets/milestones-descriptions_*.md

SOURCE FILE FORMAT:
- Markdown with source organization headings (##)
- Age range subsections (###)
- Tables with columns: Category, Subcategory, Milestones
- Milestones can have age markers like "**2M:**" for specific months
- Bullet points (•) separate individual milestones
- Multiple sources can contain the same milestone
- See: attached_assets/milestones-categorised-by-source_*.md

================================================================================
MATCHING LOGIC
================================================================================

Both scripts use title matching with normalization:
- Convert to lowercase
- Trim whitespace
- Strip age prefixes (e.g., "0-1m: " removed)

This allows descriptions to match milestones even if formatting differs.

Known Limitations:
- Titles truncated at 60 chars in database may not match
- Combined titles (e.g., "Does X, Does Y") may not match granular descriptions
- Generic numeric titles (e.g., "Boys 22 lb; Girls 20 lb") may not match

================================================================================
WORKFLOW
================================================================================

INITIAL DATABASE POPULATION:

The database should already be populated with canonical milestones from 
dev-milestones-comprehensive.md. Use the update scripts to enhance existing data:

1. Update source attributions (recommended):
   $ tsx server/parsers/update-milestone-sources.ts ./attached_assets/milestones-categorised-by-source.md
2. Update descriptions (optional):
   $ tsx server/parsers/update-milestone-descriptions-from-file.ts ./attached_assets/milestones-descriptions.md
3. Verify coverage (should have 670 milestones with 96%+ source coverage)


INCREMENTAL UPDATE WORKFLOW (Modify Existing Milestones):

1. Obtain new source attribution file (markdown format)
2. Update source attributions:
   $ tsx server/parsers/update-milestone-sources.ts <source-file>
3. Obtain new descriptions file (optional, markdown format)
4. Update descriptions (optional):
   $ tsx server/parsers/update-milestone-descriptions-from-file.ts <description-file>
5. Verify coverage statistics in script output
6. Document significant changes in replit.md

This workflow updates existing milestone records with enhanced data.

================================================================================
TROUBLESHOOTING
================================================================================

Q: Script shows "Unmatched in database" - what does this mean?
A: The description file has entries that don't match any database milestone.
   This is normal when the description file has more granular detail than
   the core milestone set.

Q: Script shows "Unmatched in file" - is this a problem?
A: These are milestones in the database without matching descriptions.
   Common causes: title truncation, combined titles, generic formats.
   Review the list and consider manual description creation if needed.

Q: How do I add descriptions for the unmatched milestones?
A: Add entries to the description file using the exact title from the database,
   then re-run the update script.

Q: Parser shows warnings - should I be concerned?
A: Check the warning message. File header warnings are normal and expected.
   Other warnings may indicate formatting issues in the source file.

Q: I see truncated milestone titles like "lids)" or "lower)" - what happened?
A: This was a parsing bug fixed in Nov 2025. The parser now correctly handles
   commas inside parentheses. If you see truncated titles:
   1. Delete the corrupted milestones from the database
   2. Re-run seed-all-milestones-from-categorised-source.ts
   3. The parser will create correctly formatted titles
   Example: "Twists things (doorknobs, lids)" instead of just "lids)"

================================================================================
MAINTENANCE
================================================================================

The parsers are designed to be zero-maintenance and handle variations in
input file formatting. If you need to:

- Add new milestone categories: Update schema.ts first
- Change title normalization: Modify milestone-description-parser.ts
- Add new description sections: Update parser and schema accordingly

Always test with sample data before processing production updates.

================================================================================
CHANGELOG
================================================================================

November 2025 - Parser v2 & Cleanup:
- Created parse-milestone-source-mappings-v2.ts with major improvements
- Smart age-prefix detection prevents title fragmentation
- Improved metadata filtering (excludes headers, category labels)
- Extracted 935 unique mappings (120% improvement, up from 424)
- Achieved 96.3% Developmental coverage, >95% all categories
- Fixed Postgres text[] array parsing bug in routes and storage
- Removed obsolete parsers (v1, old update scripts)
- Updated documentation to reflect current state

November 2025 - Canonical Milestone System:
- Established dev-milestones-comprehensive.md as single source of truth
- Implemented shared title normalization across all parsers
- Database migration: 457 canonical + 123 legacy milestones
- Added isLegacy field with NULL-safe filtering
- Created validation script for cross-file title consistency

November 2025 - Multi-Source System:
- Integrated 7 international health organizations
- Backend filtering on /api/milestones and /api/milestones/age-range
- TanStack Query cache invalidation for auto-updates
- Sources: CDC/AAP, HSE, WHO, NHS, Australian Dept of Health, Health Canada/CPS, South Africa DoH

================================================================================
